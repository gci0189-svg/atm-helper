<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATM çŸ­æº¢æ¬¾åˆ†æåŠ©æ‰‹ (PC280 æ™ºæ…§ç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 15px; }
        
        .alert-box { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
        
        .section { background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dcdfe6; position: relative; }
        .section h2 { margin-top: 0; color: #2980b9; font-size: 18px; margin-bottom: 15px; }
        
        .form-group { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-item { display: flex; flex-direction: column; flex: 1; min-width: 280px; }
        label { font-weight: bold; margin-bottom: 8px; color: #555; font-size: 14px; }
        input[type="datetime-local"], input[type="file"] { padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; background-color: #3498db; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: bold; transition: 0.3s; }
        .btn:hover { background-color: #2980b9; }
        .btn-secondary { background-color: #95a5a6; font-size: 14px; padding: 5px 10px; }
        
        /* ä»Ÿä½°çµ±è¨ˆå¡ç‰‡ */
        .summary-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .card { padding: 20px; border-radius: 10px; color: white; }
        .card.thousand { background: linear-gradient(135deg, #e67e22, #d35400); }
        .card.hundred { background: linear-gradient(135deg, #3498db, #2980b9); }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 5px; }
        .card-stats { display: flex; justify-content: space-around; }
        .stat-group { text-align: center; }
        .stat-value { font-size: 32px; font-weight: bold; display: block; }
        .stat-label { font-size: 12px; opacity: 0.9; }
        .total-amount { grid-column: span 2; background: #27ae60; text-align: center; padding: 15px; border-radius: 10px; color: white; font-size: 22px; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background-color: #f8f9fa; }
        .val-dispense { color: #27ae60; font-weight: bold; }
        .val-reject { color: #e74c3c; font-weight: bold; }
        #warningArea { display: none; background-color: #fff5f5; border-left: 5px solid #ff4d4d; padding: 15px; margin-top: 20px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§ ATM çŸ­æº¢æ¬¾åˆ†æåŠ©æ‰‹</h1>

    <div class="alert-box">
        <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> æœ¬å·¥å…·åƒ…èƒ½åˆ†æã€Œå·²è§£å¯†ã€çš„æ–‡å­—æˆ– XML å…§å®¹ã€‚è‹¥æ‚¨çš„æª”æ¡ˆæ˜¯åŠ å¯†çš„ <strong>.TRC</strong> æª”ï¼Œè«‹å…ˆä½¿ç”¨ Flight Recorder é–‹å•Ÿä¸¦ Save/Export æˆå¯è®€æ ¼å¼å¾Œå†è¡Œä¸Šå‚³ã€‚
    </div>

    <div class="section">
        <h2>1. é¸æ“‡è§£å¯†å¾Œçš„æ—¥èªŒæª”æ¡ˆ</h2>
        <input type="file" id="fileInput" multiple style="width: 100%; box-sizing: border-box;">
        <p id="fileStatus" style="font-size: 12px; color: #27ae60; margin-top: 5px; font-weight: bold;"></p>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 style="margin: 0;">2. è¨­å®šæ™‚é–“å€é–“</h2>
            <button class="btn btn-secondary" onclick="autoDetectTime()">ğŸª„ è‡ªå‹•åµæ¸¬æª”æ¡ˆæ™‚é–“</button>
        </div>
        <div class="form-group">
            <div class="input-item">
                <label>è£éˆ”æ™‚é–“ (èµ·å§‹)</label>
                <input type="datetime-local" id="startTime" step="1">
            </div>
            <div class="input-item">
                <label>å¸éˆ”æ™‚é–“ (çµæŸ)</label>
                <input type="datetime-local" id="endTime" step="1">
            </div>
        </div>
        <button class="btn" onclick="analyzeData()">é–‹å§‹æ™ºæ…§åˆ†æ</button>
    </div>

    <div id="resultSection" style="display: none;">
        <div class="summary-container">
            <div class="card thousand">
                <div class="card-title">ä»Ÿå…ƒåˆ¸çµ±è¨ˆ ($1000)</div>
                <div class="card-stats">
                    <div class="stat-group"><span class="stat-value" id="disp1000">0</span><span class="stat-label">ç™¼å‡ºå¼µæ•¸</span></div>
                    <div class="stat-group"><span class="stat-value" id="rej1000">0</span><span class="stat-label">ç¸½æ‹’éˆ”å¼µæ•¸</span></div>
                </div>
            </div>
            <div class="card hundred">
                <div class="card-title">ä½°å…ƒåˆ¸çµ±è¨ˆ ($100)</div>
                <div class="card-stats">
                    <div class="stat-group"><span class="stat-value" id="disp100">0</span><span class="stat-label">ç™¼å‡ºå¼µæ•¸</span></div>
                    <div class="stat-group"><span class="stat-value" id="rej100">0</span><span class="stat-label">ç¸½æ‹’éˆ”å¼µæ•¸</span></div>
                </div>
            </div>
            <div class="total-amount">å®¢æˆ¶æé ˜ç¸½è¨ˆï¼š<span id="totalMoney">NT$ 0</span></div>
        </div>

        <div class="section">
            <h2>ğŸ“Š è©³ç´°æ•¸æ“šæ˜ç´°</h2>
            <table>
                <thead>
                    <tr><th>éˆ”ç®±</th><th>é¢é¡</th><th>ç™¼å‡º (Disp)</th><th>æ‹’éˆ” (Rej)</th><th>åˆè¨ˆ</th></tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>

        <div id="warningArea">
            <h3 style="color: #c0392b; margin-top: 0;">âš ï¸ ç•°å¸¸å›æ”¶ç´€éŒ„ (RRET > 0)</h3>
            <ul id="warningList"></ul>
        </div>
    </div>
</div>

<script>
    let globalContent = "";

    // ç•¶æª”æ¡ˆé¸æ“‡å¾Œï¼Œé å…ˆè®€å–å…§å®¹ä»¥ä¾¿è‡ªå‹•åµæ¸¬æ™‚é–“
    document.getElementById('fileInput').addEventListener('change', function(e) {
        let files = Array.from(e.target.files);
        files.sort((a, b) => a.name.localeCompare(b.name));
        globalContent = "";
        let readCount = 0;
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                globalContent += event.target.result + "\n";
                readCount++;
                if(readCount === files.length) {
                    document.getElementById('fileStatus').innerText = `âœ… å·²è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆï¼Œæ‚¨å¯ä»¥é»æ“Šã€Œè‡ªå‹•åµæ¸¬ã€æˆ–æ‰‹å‹•å¡«å¯«æ™‚é–“ã€‚`;
                }
            };
            reader.readAsText(file);
        });
    });

    function autoDetectTime() {
        if (!globalContent) { alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆï¼"); return; }
        const timeRegex = /date="([^"]+)" time="([^"]+)"/g;
        let matches = [...globalContent.matchAll(timeRegex)];
        if (matches.length > 0) {
            // å°‡æ ¼å¼è½‰æ›ç‚º datetime-local æ‰€éœ€çš„ YYYY-MM-DDTHH:mm:ss
            let first = `${matches[0][1]}T${matches[0][2]}`;
            let last = `${matches[matches.length-1][1]}T${matches[matches.length-1][2]}`;
            document.getElementById('startTime').value = first;
            document.getElementById('endTime').value = last;
        } else {
            alert("æ‰¾ä¸åˆ°æ™‚é–“æ¨™ç±¤ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºè§£å¯†å¾Œçš„ XML æ ¼å¼ã€‚");
        }
    }

    function analyzeData() {
        const startTs = new Date(document.getElementById('startTime').value).getTime();
        const endTs = new Date(document.getElementById('endTime').value).getTime();

        if (isNaN(startTs) || isNaN(endTs)) {
            alert("è«‹è¨­å®šå®Œæ•´çš„é–‹å§‹èˆ‡çµæŸæ™‚é–“ï¼ˆåŒ…å«æ—¥æœŸèˆ‡åˆ†ç§’ï¼‰ã€‚");
            return;
        }

        let summary = { 1: { disp:0, rej:0, val:0 }, 2: { disp:0, rej:0, val:0 }, 3: { disp:0, rej:0, val:0 }, 4: { disp:0, rej:0, val:0 } };
        let warnings = [];
        let previousTokens = [];
        const lines = globalContent.split('\n');

        lines.forEach(line => {
            let tMatch = line.match(/date="([^"]+)" time="([^"]+)"/);
            if (!tMatch) return;
            let logTime = new Date(`${tMatch[1]}T${tMatch[2]}`).getTime();
            if (logTime < startTs || logTime > endTs) return;

            for(let i=1; i<=4; i++) {
                let vMatch = line.match(new RegExp(`${i}VAL=0*(\\d+)`));
                if (vMatch) summary[i].val = parseInt(vMatch[1]);
            }

            if (line.includes('type="CNG_DISP_STANDARD"')) {
                let dMatch = line.match(/>([^<]+)<\/ENTRY>/);
                if (dMatch) {
                    let tokens = dMatch[1].replace(/;/g, '').split(':').filter(t => t.trim() !== "");
                    tokens.forEach(token => {
                        if (token.endsWith('E') && previousTokens.includes(token)) return;
                        let d = token.split(',');
                        if (d.length >= 3) {
                            let idx = parseInt(d[0]);
                            if (summary[idx]) {
                                summary[idx].disp += parseInt(d[1]);
                                summary[idx].rej += parseInt(d[2]);
                            }
                        }
                    });
                    previousTokens = tokens;
                }
            }

            if (line.includes('type="STCS"')) {
                let rMatch = line.match(/RRET=([^,;]+)/);
                if (rMatch && rMatch[1] !== "00") {
                    warnings.push(`[${tMatch[1]} ${tMatch[2]}] å›æ”¶ RRET: ${rMatch[1]}`);
                }
            }
        });

        render(summary, warnings);
    }

    function render(summary, warnings) {
        document.getElementById('resultSection').style.display = 'block';
        const tbody = document.getElementById('resultTableBody');
        tbody.innerHTML = '';
        let d1000=0, r1000=0, d100=0, r100=0, totalMoney=0;

        for (let i=1; i<=4; i++) {
            let s = summary[i];
            totalMoney += (s.disp * s.val);
            if (s.val === 1000) { d1000 += s.disp; r1000 += s.rej; }
            else if (s.val === 100) { d100 += s.disp; r100 += s.rej; }

            tbody.innerHTML += `<tr><td>ç¬¬ ${i} ç®±</td><td style="c
